(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{166:function(t,s,a){t.exports=a.p+"assets/img/figure-1.1.cd4a4b1d.png"},175:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"安装节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装节点","aria-hidden":"true"}},[t._v("#")]),t._v(" 安装节点")]),t._v(" "),n("p",[t._v("参与主神联盟链，提供出块/超级节点的公司，需要提供区块链节点所需的服务器以及频宽。本文基于「主神联盟链技术白皮书」所建议的部署架构，说明如何安装与设定联盟链程式。")]),t._v(" "),n("h2",{attrs:{id:"部署架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署架构","aria-hidden":"true"}},[t._v("#")]),t._v(" 部署架构")]),t._v(" "),n("p",[t._v("逻辑上，虽然是一个联盟链的出块节点，但基于服务的可用性、安全性、扩充性，需要使用一组服务器以及相关网路服务。每组服务器部署在一个可用区(Availability Zone; AZ)或者数据中心(data center)；另外，为了网路存取控制，主机(服务器)被划分成 3 的子网路(subnet)，以及对应的安全领域(security domain)。")]),t._v(" "),n("p",[t._v("下图呈现建议的网路架构：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(166),alt:"网路架构"}})]),t._v(" "),n("h2",{attrs:{id:"准备工作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#准备工作","aria-hidden":"true"}},[t._v("#")]),t._v(" 准备工作")]),t._v(" "),n("p",[t._v("为了方便后续章节描述，下列表格定义之后会采用的变数名称以及定义：")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("名称")]),t._v(" "),n("th",[t._v("说明")]),t._v(" "),n("th",[t._v("缺省值")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("$NODE_ROOT")]),t._v(" "),n("td",[t._v("节点程式安装的路径")]),t._v(" "),n("td",[t._v("/opt/zeus")])]),t._v(" "),n("tr",[n("td",[t._v("$NODE_DATA_DIR")]),t._v(" "),n("td",[t._v("节点程式运行所需的数据")]),t._v(" "),n("td",[t._v("$NODE_ROOT/witness_node_data_dir")])]),t._v(" "),n("tr",[n("td",[t._v("$SOURCE_PATH")]),t._v(" "),n("td",[t._v("程式执行档以及设定档来源路径")]),t._v(" "),n("td",[t._v("~/zeus")])]),t._v(" "),n("tr",[n("td",[t._v("$RPC_PORT")]),t._v(" "),n("td",[t._v("RPC 的端口")]),t._v(" "),n("td",[t._v("8090")])]),t._v(" "),n("tr",[n("td",[t._v("$P2P_PORT")]),t._v(" "),n("td",[t._v("P2P 通讯用端口")]),t._v(" "),n("td",[t._v("34567")])])])]),t._v(" "),n("p",[t._v("安装过程需要有下列档案：")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("档名")]),t._v(" "),n("th",[t._v("说明")]),t._v(" "),n("th",[t._v("备注")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("witness_node")]),t._v(" "),n("td",[t._v("节点主程式")]),t._v(" "),n("td",[t._v("支援 Ubuntu 16.06 x86_64")])]),t._v(" "),n("tr",[n("td",[t._v("cli_wallet")]),t._v(" "),n("td",[t._v("钱包命令列介面")]),t._v(" "),n("td",[t._v("建立以及管理帐户")])]),t._v(" "),n("tr",[n("td",[t._v("config.ini")]),t._v(" "),n("td",[t._v("节点程序设定档")]),t._v(" "),n("td",[t._v("范例档")])]),t._v(" "),n("tr",[n("td",[t._v("genesis.json")]),t._v(" "),n("td",[t._v("区块链创世文件")]),t._v(" "),n("td")])])]),t._v(" "),n("h3",{attrs:{id:"主机需求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#主机需求","aria-hidden":"true"}},[t._v("#")]),t._v(" 主机需求")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("规格名称")]),t._v(" "),n("th",[t._v("规格说明")]),t._v(" "),n("th",[t._v("适用主机")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("m4.4xlarge")]),t._v(" "),n("td",[t._v("vCPU: 16 cores/RAM: 64GiB/SSD: 100GiB")]),t._v(" "),n("td",[t._v("_ 主要出块节点"),n("br"),t._v(" _ 备援出块节点")])]),t._v(" "),n("tr",[n("td",[t._v("m4.xlarge")]),t._v(" "),n("td",[t._v("vCPU: 4 cores/RAM: 16GiB/SSD: 100GiB")]),t._v(" "),n("td",[t._v("_ API 全节点"),n("br"),t._v(" _ 出口全节点"),n("br"),t._v(" * 入口全节点")])])])]),t._v(" "),n("h3",{attrs:{id:"系统需求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#系统需求","aria-hidden":"true"}},[t._v("#")]),t._v(" 系统需求")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("项目")]),t._v(" "),n("th",[t._v("需求")]),t._v(" "),n("th",[t._v("备注")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("操作系统(OS)")]),t._v(" "),n("td",[t._v("Ubuntu 16.04")]),t._v(" "),n("td")])])]),t._v(" "),n("h3",{attrs:{id:"申请成为出块会员"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#申请成为出块会员","aria-hidden":"true"}},[t._v("#")]),t._v(" 申请成为出块会员")]),t._v(" "),n("p",[t._v("要申请成为出块会员，需要先有一个普通帐户。可以透过主神链发起方所提供的网页钱包建立一个普通帐户。有了普通帐户的名称与私钥，可以透过互操作命令介面 cli_wallet 申请成为出块会员。")]),t._v(" "),n("p",[t._v("假设运维人员已经登入某台节点服务器，在终端机执行下列指令启动互操作介面：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("cd")]),t._v(" /opt/zeus\n$ ./cli_wallet ws://"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("节点 IP 地址"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(":8090"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rpc port"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("其中，<节点 IP 地址> 是联盟链已经在执行的节点主机。\n下面指令都是在 cli_wallet 的介面中执行。")]),t._v(" "),n("h3",{attrs:{id:"解锁钱包客户端"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解锁钱包客户端","aria-hidden":"true"}},[t._v("#")]),t._v(" 解锁钱包客户端")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("set_password "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("要创建的客户端密码"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\nunlock "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("客户端密码"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),n("h3",{attrs:{id:"导入现有钱包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#导入现有钱包","aria-hidden":"true"}},[t._v("#")]),t._v(" 导入现有钱包")]),t._v(" "),n("p",[t._v("将现有帐户的私钥导入。")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("import_key "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("帐户名"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("私钥"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("  "),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n")])])]),n("p",[t._v("导入成功后会更新钱包文件，可以透过 "),n("code",[t._v("list_my_accounts")]),t._v(" 查看有哪些帐户。")]),t._v(" "),n("h3",{attrs:{id:"帐户升级成终身会员"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#帐户升级成终身会员","aria-hidden":"true"}},[t._v("#")]),t._v(" 帐户升级成终身会员")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("upgrade_account "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("帐户名"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n")])])]),n("h3",{attrs:{id:"帐户升级成出块会员"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#帐户升级成出块会员","aria-hidden":"true"}},[t._v("#")]),t._v(" 帐户升级成出块会员")]),t._v(" "),n("p",[t._v("升级成出块会员需要消耗虚拟币。")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("create_witness "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("帐户名"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("  "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("推广网站"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n")])])]),n("p",[t._v("其中，< 推广网站>是合作方提供推广信息用的网址。")]),t._v(" "),n("h2",{attrs:{id:"程式安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#程式安装","aria-hidden":"true"}},[t._v("#")]),t._v(" 程式安装")]),t._v(" "),n("p",[t._v("节点主机都需要按照下列各节描述的步骤安装节点程式。\n安装相依套件")]),t._v(" "),n("p",[t._v("节点需要执行环境预先安装有相关的系统套件，在命令列中使用下列指令安装：")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("install")]),t._v(" libbz2-dev libdb++-dev \\\nlibdb-dev libssl-dev openssl \\\n libreadline-dev libtool libcurl4-openssl-dev \\\n libcurl4-openssl-dev libboost-all-dev\n")])])]),n("p",[t._v("$ 为命令提示符号，不用输入。\n建立运行路径\n$ mkdir -p /opt/zeus")]),t._v(" "),n("h3",{attrs:{id:"建立运行路径"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#建立运行路径","aria-hidden":"true"}},[t._v("#")]),t._v(" 建立运行路径")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /opt/zeus\n")])])]),n("h3",{attrs:{id:"复制节点执行档"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#复制节点执行档","aria-hidden":"true"}},[t._v("#")]),t._v(" 复制节点执行档")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("cp")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$SOURCE_PATH")]),t._v("/witness_node "),n("span",{attrs:{class:"token variable"}},[t._v("$NODE_ROOT")]),t._v("/\n$ "),n("span",{attrs:{class:"token function"}},[t._v("chmod")]),t._v(" a+x "),n("span",{attrs:{class:"token variable"}},[t._v("$NODE_ROOT")]),t._v("/witness_node\n")])])]),n("h3",{attrs:{id:"产生初始档案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#产生初始档案","aria-hidden":"true"}},[t._v("#")]),t._v(" 产生初始档案")]),t._v(" "),n("p",[t._v("节点程式数据路径需要初始化，执行下列指令：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ chdir "),n("span",{attrs:{class:"token variable"}},[t._v("$NODE_ROOT")]),t._v("\n$ ./witness_node\n")])])]),n("p",[t._v("上述会在 $NODE_ROOT 路径中产生一个 "),n("code",[t._v("witness_node_data_dir")]),t._v(" 子路径，这个目录就是 $NODE_DATA_DIR 。")]),t._v(" "),n("h3",{attrs:{id:"复制设定档"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#复制设定档","aria-hidden":"true"}},[t._v("#")]),t._v(" 复制设定档")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("cp")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$SOURCE_PATH")]),t._v("/config.ini "),n("span",{attrs:{class:"token variable"}},[t._v("$NODE_DATA_DIR")]),t._v("/\n")])])]),n("p",[t._v("这个设定档提供缺省或者建议的设定值，实际运行需要调整的设定在「程式设定」这一章说明。")]),t._v(" "),n("h2",{attrs:{id:"出口-入口全节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#出口-入口全节点","aria-hidden":"true"}},[t._v("#")]),t._v(" 出口/入口全节点")]),t._v(" "),n("h3",{attrs:{id:"代理服务器安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代理服务器安装","aria-hidden":"true"}},[t._v("#")]),t._v(" 代理服务器安装")]),t._v(" "),n("ol",[n("li",[t._v("安装软件")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" add-apt-repository ppa:nginx/stable\n$ "),n("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n$ "),n("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("install")]),t._v(" -y nginx-extras\n")])])]),n("ol",{attrs:{start:"2"}},[n("li",[t._v("基本环境设定")])]),t._v(" "),n("p",[t._v("编辑主要设定档 "),n("code",[t._v("/etc/nginx/nginx.conf")]),t._v("， 搜寻 ”include /etc/nginx/conf.d/"),n("em",[t._v(".conf;”，将 ”include /etc/nginx/conf.d/")]),t._v(".conf;”，移出 http { } 区块外。")]),t._v(" "),n("p",[t._v("新增设定档 "),n("code",[t._v("/etc/nginx/conf.d/ingress.conf")]),t._v("，内容如下(IP 位址与端口根据环境修改)))：")]),t._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[t._v("stream "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" mtningress "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("10.3")]),n("span",{attrs:{class:"token number"}},[t._v(".4")]),n("span",{attrs:{class:"token number"}},[t._v(".11")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token number"}},[t._v("34567")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("##本地端入口节点")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("35789")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("tcp_nodelay")]),t._v(" on"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" mtningress"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_certificate")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("opt"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token keyword"}},[t._v("ssl")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("zeusCA"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("motion"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("one"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("crt"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("##入口节点证书")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_certificate_key")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("opt"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token keyword"}},[t._v("ssl")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("zeusCA"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("motion"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("one"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("##入口节点私钥")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_client_certificate")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("opt"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token keyword"}},[t._v("ssl")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("zeusCA"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("ca"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("crt"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("## 本地节点root CA，外部节点连线必须基于此CA产出Client证书")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_protocols")]),t._v(" TLSv1 TLSv1"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),t._v(" TLSv1"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token number"}},[t._v("2")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_ciphers")]),t._v(" HIGH"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("aNULL"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("MD5"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_verify_client")]),t._v(" on"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("## 开启连线客户端证书认证")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_session_cache")]),t._v("     shared"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token keyword"}},[t._v("SSL")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token number"}},[t._v("20")]),t._v("m"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_session_timeout")]),t._v("   "),n("span",{attrs:{class:"token number"}},[t._v("4")]),t._v("h"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        ssl_handshake_timeout "),n("span",{attrs:{class:"token number"}},[t._v("30")]),t._v("s"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("proxy_connect_timeout")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("7")]),t._v("d"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("allow")]),t._v(" xxx"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("xxx"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("xxx"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("xxx"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token number"}},[t._v("32")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("##外部连入本地节点来源IP")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("deny")]),t._v(" all"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("新增 Engress 设定档 "),n("code",[t._v("/etc/nginx/conf.d/engress.conf")]),t._v("，内容如下：")]),t._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[t._v("stream "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" mtnengress "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("18.182")]),n("span",{attrs:{class:"token number"}},[t._v(".93")]),n("span",{attrs:{class:"token number"}},[t._v(".83")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token number"}},[t._v("35789")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("###联盟主炼入口节点 1")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("18.182")]),n("span",{attrs:{class:"token number"}},[t._v(".82")]),n("span",{attrs:{class:"token number"}},[t._v(".151")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token number"}},[t._v("35789")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("###联盟主炼入口节点 2")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("35789")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("#本地出口用端口，用来连线到联盟主链")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" mtnengress"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_ssl on"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_ssl_certificate "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("opt"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token keyword"}},[t._v("ssl")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("zeusCA"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("chain"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("client"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("crt"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("##联盟主链提供公钥证书")]),t._v("\n        proxy_ssl_certificate_key "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("opt"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token keyword"}},[t._v("ssl")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("zeusCA"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("cgain"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("client"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("##提供给联盟主链产生证书私钥")]),t._v("\n        proxy_ssl_protocols TLSv1 TLSv1"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),t._v(" TLSv1"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token number"}},[t._v("2")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_ssl_ciphers HIGH"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("aNULL"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("MD5"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_ssl_verify_depth "),n("span",{attrs:{class:"token number"}},[t._v("2")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("proxy_ssl_session_reuse")]),t._v(" on"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("allow")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("10.3")]),n("span",{attrs:{class:"token number"}},[t._v(".0")]),n("span",{attrs:{class:"token number"}},[t._v(".0")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token number"}},[t._v("16")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("deny")]),t._v(" all"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("ol",{attrs:{start:"3"}},[n("li",[t._v("连线用 SSL 证书核发")])]),t._v(" "),n("p",[n("strong",[t._v("OpenSSL 环境变数修改")]),t._v("\n编辑 "),n("code",[t._v("/usr/lib/ssl/openssl.cnf")]),t._v("档案")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("[ CA_default ]\n\ndir             = /opt/ssl/zeusCA               # Where everything is kept\ncerts           = $dir/certs            # Where the issued certs are kept\ncrl_dir         = $dir/crl              # Where the issued crl are kept\ndatabase        = $dir/index.txt        # database index file.\n#unique_subject = no                    # Set to 'no' to allow creation of\n                                        # several ctificates with same subject.\nnew_certs_dir   = $dir/newcerts         # default place for new certs.\n\ncertificate     = $dir/cacert.pem       # The CA certificate\nserial          = $dir/serial           # The current serial number\ncrlnumber       = $dir/crlnumber        # the current crl number\n                                        # must be commented out to leave a V1 CRL\ncrl             = $dir/crl.pem          # The current CRL\nprivate_key     = $dir/private/cakey.pem# The private key\nRANDFILE        = $dir/private/.rand    # private random number file\n")])])]),n("p",[n("strong",[t._v("建立核发目录")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("$ mkdir -p /opt/ssl/zeusCA/newcerts\n$ mkdir -p /opt/ssl/zeusCA/private\n$ cd /opt/ssl/zeusCA\n$ touch index.txt\n$ echo ‘01’ > serial\n")])])]),n("p",[n("strong",[t._v("建立 Root CA")])]),t._v(" "),n("p",[t._v("建立Root CA私钥")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("$ openssl genrsa -des3 -out ca.key 2048\n")])])]),n("p",[t._v("产生无密码私钥")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("$ openssl rsa -in ca.key -out ca_decrypted.key\n")])])]),n("p",[t._v("产生公钥")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("$ openssl req -new -x509 -days 18250 -key ca.key -out ca.crt\n")])])]),n("p",[n("strong",[t._v("建立连线证书")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("建立连线用证书私钥\n$ openssl genrsa -des3 -out motion.one.pem 2048\n\n产生无密码私钥\n$ openssl rsa -in motion.one.pem -out motion.one.key\n\n产生签名档\n$ openssl req -new -key motion.one.pem -out motion.one.csr\n\n")])])]),n("p",[n("strong",[t._v("连线证书签署")])]),t._v(" "),n("p",[t._v("签署证书")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("$ openssl ca -policy policy_anything -days 7300 -cert ca.crt -keyfile ca.key -in motion.one.csr -out motion.one.crt\n")])])]),n("p",[t._v("追加 Root CA 内容")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("cat ca.crt>> motion.one.crt\n")])])])])}],e=a(0),r=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);s.default=r.exports}}]);